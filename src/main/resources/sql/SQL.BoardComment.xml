<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.portfolio.www.repository.BoardCommentRepository">

  	<insert id="save" parameterType="BoardCommentDto">
  		<selectKey resultType="Integer" keyProperty="commentSeq" order="BEFORE">
		SELECT IFNULL(MAX(comment_seq)+1, 1) FROM board_comment 
		</selectKey>
  	 	INSERT INTO forum.board_comment
			(comment_seq, lvl, content, board_seq, board_type_seq, member_seq, root_comment_seq, comment_grp, ord_seq, reg_dtm)
			SELECT #{commentSeq}, #{lvl}, #{content}, #{boardSeq}, #{boardTypeSeq}, #{memberSeq}, 
			<choose>
				<when test='rootCommentSeq != 0'>
				${rootCommentSeq},
				</when>
				<otherwise>
				${commentSeq},
				</otherwise>
			</choose>
			<choose>
				<when test='commentGrp != 0'>
				${commentGrp},
				</when>
				<otherwise>
				(SELECT IFNULL(MAX(comment_grp)+1, 1) FROM board_comment WHERE board_seq = #{boardSeq} AND board_type_seq = #{boardTypeSeq}),
				</otherwise>
			</choose>
			<choose>
				<when test='ordSeq != 0'>
				${ordSeq},
				</when>
				<otherwise>
				1,
				</otherwise>
			</choose>
			DATE_FORMAT(now(),'%Y%m%d%H%i%s')
	</insert>
	
	<update id="modify" parameterType="BoardCommentDto">
	 UPDATE forum.board_comment
		SET update_dtm = DATE_FORMAT(now(),'%Y%m%d%H%i%s')
		<if test='content != null'>
			,content = #{content}
		</if>
		<if test='ordSeq != null'>
			,ord_seq = #{ordSeq}
		</if>
	  WHERE comment_seq = #{commentSeq}
	</update>
	
	<delete id="delete" parameterType="int">
	 DELETE FROM forum.board_comment 
	  WHERE comment_seq = #{commentSeq}
	</delete>
	
	<select id="getList" parameterType="BoardCommentDto" resultType="BoardCommentDto">
		select comment_seq, lvl, content, board_seq, board_type_seq, m.member_nm, root_comment_seq, comment_grp, ord_seq, bc.reg_dtm
		  from board_comment bc
 	      join member m on bc.member_seq = m.member_seq
 	     WHERE board_seq = #{boardSeq}
           AND board_type_seq = #{boardTypeSeq}
           <if test='commentGrp != 0'>
           AND comment_grp = #{commentGrp}
           </if>
           <if test='gtOrdSeq != 0'>
           AND ord_seq > #{gtOrdSeq}
           </if>
      ORDER BY root_comment_seq, comment_grp, ord_seq, bc.reg_dtm asc
	</select>
	
	<select id="getAllCommentList" resultType="BoardCommentDto">
		select comment_seq, lvl, content, board_seq, board_type_seq, m.member_nm, root_comment_seq, comment_grp, ord_seq, bc.reg_dtm
		  from board_comment bc
 	      join member m on bc.member_seq = m.member_seq
 	     WHERE board_seq = #{boardSeq}
           AND board_type_seq = #{boardTypeSeq}
      ORDER BY root_comment_seq, comment_grp, ord_seq, bc.reg_dtm asc
	</select>
	
	<select id="count" resultType="int">
	 SELECT COUNT(*)
	   FROM forum.board_comment
	  WHERE board_seq = #{boardSeq}
		AND board_type_seq = #{boardTypeSeq}
	</select>
	
	<select id="getVote" resultType="BoardCommentVoteDto">
	 SELECT * FROM forum.comment_vote
	  WHERE comment_seq = #{commentSeq}
		AND member_seq = #{memberSeq}
	</select>
	
	<insert id="addVote" parameterType="BoardCommentVoteDto">
	 INSERT INTO forum.comment_vote
	 (comment_seq, member_seq, is_like, ip, reg_dtm)
	 VALUES(#{commentSeq}, #{memberSeq}, #{isLike}, #{ip}, DATE_FORMAT(now(),'%Y%m%d%H%i%s'))
	</insert>
	
	<delete id="deleteVote" parameterType="int">
	 DELETE FROM forum.comment_vote
	  WHERE comment_seq = #{commentSeq}
	</delete>
	
	<update id="updateVote" parameterType="BoardCommentVoteDto">
	 UPDATE forum.comment_vote
	    SET is_like = #{isLike},
		    reg_dtm = DATE_FORMAT(now(),'%Y%m%d%H%i%s'),
		    ip = #{ip}
	  WHERE comment_seq = #{commentSeq}
	</update>
	
	<select id="getLikeTotal" parameterType="int" resultType="int">
	 SELECT COUNT(comment_seq)
	   FROM forum.comment_vote
	  WHERE comment_seq = #{commentSeq}
	    AND is_like = 'Y'
	</select>
	
	<select id="getUnlikeTotal" parameterType="int" resultType="int">
	 SELECT COUNT(comment_seq) 
	   FROM forum.comment_vote 
	  WHERE comment_seq = #{commentSeq}
		AND is_like = 'N'
	</select>
</mapper>